<!DOCTYPE html>
<html>
    <head>
    <title>Tic-Tac-Toe!</title>
    <style>
      body {
          background-color: #333;
          text-align: center;
          padding-top: 5em;
          height: 100%;
      }
      div#board {
          margin: auto;
          background-color: #eee;
          display: inline-block;
      }
      #board table {
          border-collapse: collapse;
          text-align: center;
          vertical-align: middle;
      }
      #board table tr td {
          width: 100px;
          height: 100px;
          background-color: #ccc;
      }
      #board table tr td.top,
      #board table tr td.bottom,
      #board table tr td.left,
      #board table tr td.right {
          border: none;
      }
      #board table tr td.center {
          border-left: 5px solid #333;
          border-right: 5px solid #333;
      }
      #board table tr td.middle {
          border-top: 5px solid #333;
          border-bottom: 5px solid #333;
      }
      a.cell_link {
          display: block;
          font-size: 200%;
          font-color: black;
          text-decoration: none;
          background: #eee url('/media/img/empty.png') no-repeat 5px 5px;
          height: 100px;
      }
      a.cell_link.x,
      a.cell_link.x:hover {
          background-image: url('/media/img/x.png');
          cursor: default;
      }
      a.cell_link.o,
      a.cell_link.o:hover {
          background-image: url('/media/img/o.png');
          cursor: default;
      }
      a.cell_link.empty.x_turn:hover {
          background-image: url('/media/img/x_hover.png');
      }
      a.cell_link.empty.o_turn:hover {
          background-image: url('/media/img/o_hover.png');
      }
      #feedback {
          width: 200px;
          margin: auto;
          text-align: center;
      }
      #feedback p {
          margin-top: 1em;
          font-size: 125%;
          padding: 1em;
          background-color: #eee;
      }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js">
    </script>
    <script>
        var player, human;
        player = 'x'
        human = 'x';
        server = (human=='x')? 'o' : 'x';
        function toggle_player() {
            if (player == 'x') {
                player = 'o';
            } else {
                player = 'x';
            }
        }
        function set_cell_hover() {
            $('a.cell_link').removeClass('x_turn').removeClass('o_turn');
            $('a.empty').addClass(player + '_turn');
        }
        function is_valid_click(target) {
            if (!target.hasClass('empty')) {
                return false;
            }
            return true;
        }
        function select_cell(target, play) {
            target.removeClass('empty');
            target.slideUp(50, function () {
                target.addClass(play);
                target.slideDown(50);
            });
        }
        function djangos_turn() {
            $('#feedback p').text("Let me see...");
            $.getJSON(
                '{% url server_move %}',
                {
                    player: server
                },
                function(json) {
                    if (json.status == 'over') {
                        $('#feedback p').text("game over");
                        player = 'x';
                        human = 'x';
                    } else if (json.status == 'error') {
                        $('#feedback p').text("ooops, I did something bad");
                    } else {
                        cell_id = json.value;
                        target = $('td#' + cell_id).children('a.cell_link');
                        select_cell(target, server);
                        toggle_player();
                        set_cell_hover();
                        $('#feedback p').text("Take that, you dirty rat!");
                    }
                }
            );
        }
        function players_turn(target) {
            var clicked_id;
            clicked_id = target.parent('td').attr('id');
            $.getJSON(
                '{% url user_move %}',
                {
                    cell_id: clicked_id,
                    player: human
                },
                function(json) {
                    if (json.status != 'OK') {
                        $('#feedback p').text("That move is not legal. Try again");
                    } else {
                        select_cell(target, human);
                        toggle_player();
                        set_cell_hover();
                        $('#feedback p').text("Nice move, but not nice enough!");
                        djangos_turn();
                    }
                }
            );
        }
        function handle_play(event) {
            var target, container, clicked_id;
            event.preventDefault();
            target = $(event.target)
            if (target.is('a')) {
                if (is_valid_click(target)) {
                    if (player == human) {
                        players_turn(target);
                    } else {
                        $('#feedback p').text("It's not your turn.  Be patient!");
                    }
                } else {
                    $('#feedback p').text("Sorry, someone's already picked that square");
                }
            }
        }
        function clear_board(event) {
            event.preventDefault();
            $.getJSON(
                '{% url clear_board %}',
                {},
                function(json) {
                    if (json.status != 'OK') {
                        $('#feedback p').text("Oh damn.  There's been an error")
                    } else {
                        $('a.cell_link').removeClass('x')
                                        .removeClass('o')
                                        .addClass('empty');
                        set_cell_hover();
                        player = 'x';
                    }
                }
            );
        }
        $(document).ready(function() {
            set_cell_hover();
            $("#board table").click(handle_play);
            $("#buttons a#clear").click(clear_board);
        })
    </script>
    </head>
    <body>
        <div id="board">
            <table>
                <tr>
                {% for row in board %}
                    {% for cell_label, value, cell_id in row  %}
                    <td class="{{ cell_label }}" id="{{ cell_id }}">
                      <a class="cell_link {% if value == '' %}empty{% else %}{{ value }}{% endif %}" href=".">&nbsp;</a>
                    </td>
                    {% endfor %}
                {% if forloop.last %}
                </tr>
                {% else %}
                </tr>
                <tr>
                {% endif %}
                {% endfor %}
            </table>
        </div>
        <div id="feedback">
            <p>You go first</p>
        </div>
        <div id="buttons">
            <a href="." id="clear">Clear the Board!</a>
    </body>
</html>